import frappe
from frappe.model.document import Document
import datetime


class Card(Document):
    @frappe.whitelist()
    def scan_barcode(barcode):
        cards = frappe.get_all('Card', fields=[
                               'name', 'prefix', 'suffix', 'card_title'], filters={'active': 1})
        cards_count = len(cards)

        encoded_barcode = barcode

        # Decode the barcode and display it
        try:
            barcode = barcode.encode('ISO-8859-1').decode('windows-1256')

        except Exception as e:
            print(f"Error in trying to decode the barcode: {e}")

        chopped_barcode = barcode.split('#')
        barcode_length = len(barcode)
        array_barcode = list(barcode)

        for card in cards:

            if card.prefix is not None and card.prefix.strip():
                
                prefix_length = len(card.prefix)
                if prefix_length <= barcode_length:
                    prefix_substr = barcode[:prefix_length]
                if prefix_substr == card.prefix:
                    print("the card is " + card.card_title + " card for now")
                    
                    
                   
                    if  not bool(card.suffix):
                        print('suffix yess')
                        suffix_substr = None
                        if suffix_substr == card.suffix:

                            is_castable = True
                            count = 0
                            fields = frappe.get_all('Field', filters={'parent': card.name, 'display': 1},
                                                    fields=['name', 'server_title', 'display_title', 'order', 'display'])
                            print(len(chopped_barcode))
                            print(len(fields))
                            if len(chopped_barcode) != len(fields):
                                
                                print(len(chopped_barcode))
                                print(len(fields))
                                print('fjfhfhfnbf')
                                continue

                            else:
                                print("the card is " +
                                      card.card_title + " card for nowww")

                                fields = frappe.get_all('Field', filters={'parent': card.name, 'display': 1},
                                                    fields=['name', 'server_title', 'display_title', 'order', 'display'])
                                print(fields)
                                print('heyyyyyy')
                                for field in fields:
                                    print(len(fields))
                                    field_value = chopped_barcode[field.order - 1]
                                    if field_value and field_value.strip() and field.cast_datatype:
                                        casted_value = None
                                        if field.cast_datatype == "java.lang.String":
                                            try:
                                                casted_value = field_value
                                                print(casted_value +
                                                      " is String")
                                            except ValueError:
                                                is_castable = False
                                        elif field.cast_datatype == "java.lang.Integer":
                                            try:
                                                casted_value = int(field_value)
                                                print(casted_value)
                                                print("is integer")
                                            except ValueError:
                                                is_castable = False
                                                print("errorrr")
                                        elif field.cast_datatype == "java.lang.Long":
                                            try:
                                                casted_value = int(field_value)
                                            except ValueError:
                                                is_castable = False
                                        elif field.cast_datatype == "java.util.Date":
                                            try:
                                                formatter = datetime.datetime.strptime(
                                                    field_value, "%d/%m/%Y")
                                                casted_value = formatter.date()
                                            except ValueError:
                                                is_castable = False
                            break

                    elif card.suffix is not None and not card.suffix.strip():
                        fields = frappe.get_all('Field', filters={'parent': card.name, 'display': 1},
                                                fields=['name', 'server_title', 'display_title', 'order', 'display'])
                        print(fields)
                        is_castable = True
                        count = 0
                        if len(chopped_barcode) != len(fields):
                            print(len(chopped_barcode))
                            print(len(fields))
                            continue

                        else:
                            for field in fields:

                                field_value = chopped_barcode[field.order - 1]

                                if field_value and field_value.strip() and field.cast_datatype:
                                    casted_value = None
                                    if field.cast_datatype == "java.lang.String":
                                        try:
                                            casted_value = field_value
                                            print(casted_value + " is String")
                                        except ValueError:
                                            is_castable = False
                                    elif field.cast_datatype == "java.lang.Integer":
                                        try:
                                            casted_value = int(field_value)
                                            print(casted_value)
                                            print("is integer")
                                        except ValueError:
                                            is_castable = False
                                            print("errorrr")
                                    elif field.cast_datatype == "java.lang.Long":
                                        try:
                                            casted_value = int(field_value)
                                        except ValueError:
                                            is_castable = False
                                    elif field.cast_datatype == "java.util.Date":
                                        try:
                                            formatter = datetime.datetime.strptime(
                                                field_value, "%d/%m/%Y")
                                            casted_value = formatter.date()
                                        except ValueError:
                                            is_castable = False
                                count = count+1

                        break

            elif card.prefix is None or not card.prefix.strip():

                prefix_length = len(card.prefix)
                if prefix_length <= barcode_length:
                    prefix_substr = barcode[:prefix_length]
                if prefix_substr == card.prefix:

                    fields = frappe.get_all('Field', filters={'parent': card.name, 'display': 1},
                                            fields=['name', 'server_title', 'display_title', 'order', 'display'])

                    if card.suffix is not None and card.suffix.strip():

                        suffix_length = len(card.suffix)
                        if suffix_length <= barcode_length:
                            print('suffix not noneee2')
                            suffix_substr = barcode[-suffix_length:]
                            if suffix_substr == card.suffix:
                                print('suffix not noneee3')
                                if len(chopped_barcode) != len(fields):

                                    continue

                                else:
                                    print("the card is " +
                                          card.card_title + " card for nowww")
                                    print("there is suffix then")
                            fields = frappe.get_all('Field', filters={'parent': card.name, 'display': 1},
                                                    fields=['name', 'server_title', 'display_title', 'order', 'display'])
                            print(fields)
                            is_castable = True
                            count = 0
                            for field in fields:
                                print(len(fields))
                                field_value = chopped_barcode[field.order - 1]
                                if field_value and field_value.strip() and field.cast_datatype:
                                    casted_value = None
                                    #if field.cast_datatype == "java.lang.String":
                                        #try:
                                            #casted_value = field_value
                                            #print(casted_value + " is String")
                                        #except ValueError:
                                            #is_castable = False
                                    if field.cast_datatype == "java.lang.Integer":
                                        try:
                                            casted_value = int(field_value)
                                            print(casted_value)
                                            print("is integer")
                                        except ValueError:
                                            is_castable = False
                                            print("errorrr")
                                    elif field.cast_datatype == "java.lang.Long":
                                        try:
                                            casted_value = int(field_value)
                                        except ValueError:
                                            is_castable = False
                                    elif field.cast_datatype == "java.util.Date":
                                        try:
                                            formatter = datetime.datetime.strptime(
                                                field_value, "%d/%m/%Y")
                                            casted_value = formatter.date()
                                        except ValueError:
                                            is_castable = False

                    elif card.suffix is not None and not card.suffix.strip():

                        fields = frappe.get_all('Field', filters={'parent': card.name, 'display': 1},
                                                fields=['name', 'server_title', 'display_title', 'order', 'display'])

                        is_castable = True
                        count = 0

                    if len(chopped_barcode) != len(fields):

                        continue

                    else:
                        print("the card is " + card.card_title + " card for noww")
                        print(fields)
                        for field in fields:

                            field_value = chopped_barcode[field.order - 1]

                            if field_value and field_value.strip() and field.cast_datatype:
                                casted_value = None
                                if field.cast_datatype == "java.lang.String":
                                    try:
                                        casted_value = field_value
                                        print(casted_value + " is String")
                                    except ValueError:
                                        is_castable = False
                                elif field.cast_datatype == "java.lang.Integer":
                                    try:
                                        casted_value = int(field_value)
                                        print(casted_value)
                                        print("is integer")
                                    except ValueError:
                                        is_castable = False
                                        print("errorrr")
                                elif field.cast_datatype == "java.lang.Long":
                                    try:
                                        casted_value = int(field_value)
                                    except ValueError:
                                        is_castable = False
                                elif field.cast_datatype == "java.util.Date":
                                    try:
                                        formatter = datetime.datetime.strptime(
                                            field_value, "%d/%m/%Y")
                                        casted_value = formatter.date()
                                    except ValueError:
                                        is_castable = False
                                        count = count+1
                    break
